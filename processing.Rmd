```{r}
library(dplyr)
library(tidyr)
library(lubridate)
library(readr)
library(stringr)
library(qualtRics)
ema <- read_survey("data/regret_ema.csv")
intake <- read_survey("data/regret_ema_intake.csv")
```

```{r}
df_ema <- ema %>%
  #filter(str_detect(RecordedDate, "^\\d{4}-\\d{2}-\\d{2}")) %>%  # eliminate junk rows.. lmk if you want me to move away from regex
  mutate(RecordedDate = ymd_hms(RecordedDate)) %>%
  arrange(PID, RecordedDate) %>%
  group_by(PID) %>%
  mutate(PING_NUM = row_number()) %>%
  ungroup() %>%
  select(-c(StartDate:UserLanguage)) %>%
    relocate(PID, DAY_NUM, SURVEY_TYPE, DECISION, DECISION_TO_SHOW, NEXT_SURVEY) %>%
    filter(PID != "000000")
```

```{r}
df_intake <- intake %>%
  group_by(PID) %>%
  arrange(desc(rowSums(!is.na(.)))) %>%
  slice(1) %>%
  ungroup() %>%
  select(-c(StartDate:UserLanguage)) %>%
   relocate(PID) %>%
    filter(PID != "000000")
```

```{r}
df_ema_intake <- df_ema %>%
  #unite("resolved", `resolved...28`, `resolved...47`) %>%
    rename(resolved = `resolved...28`) %>%
    mutate(
    regret_yn = as.numeric(regret_yn),
    resolved = as.numeric(resolved)
  ) %>%
  mutate(SURVEY_TYPE = ifelse(is.na(SURVEY_TYPE), "first", SURVEY_TYPE)) %>%
  left_join(df_intake, by = "PID") %>%
  arrange(PID, PING_NUM) %>%
  group_by(PID) %>%
  mutate(regret_START = ifelse(
    (regret_yn == 2 & resolved == 2),
    1, 0)) %>%
  mutate(
    regret_END = ifelse(SURVEY_TYPE == "followup" & lead(SURVEY_TYPE == "general"),
                         1, 0)
    ) %>%
  # if survey_type==followup, find the PING_NUM where regret_START == 1, PING_NUM where regret_end == 1; fill the followup_inxed with row_number (1 2 3...)
  # regret_index within participant 
  mutate(regret_index = {
    idx <- rep(NA_integer_, n())
    counter <- 1
    i <- 1
    while (i <= n()) {
      if (isTRUE(regret_yn[i] == 2 && resolved[i] == 1)) {
          start <- i
          end <- i + 1
          while (end <= n() && !isTRUE(resolved[end] == 2)) {
            end <- end + 1
        }
        idx[start:(end -1)] <- counter
        counter <- counter + 1
        i <- end
      } else {
        i <- i + 1
      }
    }
    idx
  }
  ) %>%
  ungroup()

readr::write_csv(df_ema_intake, "processed_merged.csv")
```

```{r}
distinct_events <- df_ema_intake %>%
  filter(!is.na(regret_index)) %>%
  group_by(PID, regret_index) %>%
  summarise(followups = n(), .groups = "drop") # to get one row per ping

event_summary_pid <- distinct_events %>%
  group_by(PID) %>% 
  summarise(num_events = n(), avg_followups = mean(followups), sd_followups = sd(followups), min_followups = min(followups), max_followups = max(followups))
print(event_summary_pid)

event_summary_overall <- event_summary_pid %>%
  summarise(
    M_events = mean(num_events),
    SD_events = sd(num_events),
    min_events = min(num_events),
    max_events = max(num_events),
    M_followups = mean(avg_followups),
    SD_followups = sd(avg_followups),
    min_followups = min(min_followups),
    max_followups = max(max_followups)
  )
print(event_summary_overall)

#Na's due to only one event? 
```
